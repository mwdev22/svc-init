#!/bin/bash

# svc-init - initialize a new microservice go project in the current directory

REPO_URL="https://github.com/mwdev22/svc-init.git"
TEMPLATE_DIR="/opt/svc-init"

TEMPLATE_GROUP="rest"
TEMPLATE_TYPE=""

usage() {
    cat <<-USAGE
Usage: $(basename "$0") [-n|--noupdate] [-grpc|-rest] [flat|standard]

Options:
  -n, --noupdate    Do not update or pull the template repository (require templates already present in $TEMPLATE_DIR)

Examples:
  $(basename "$0") -grpc flat            # use grpc/flat template (updates templates)
  $(basename "$0") -n -rest standard     # use rest/standard template and do NOT update templates
  $(basename "$0") flat                  # shorthand, assumes rest/flat
USAGE
    exit 1
}

NO_UPDATE=0
filtered_args=()
for a in "$@"; do
    if [ "$a" = "-n" ] || [ "$a" = "--noupdate" ]; then
        NO_UPDATE=1
    else
        filtered_args+=("$a")
    fi
done

set -- "${filtered_args[@]}"

if [ "$#" -eq 0 ]; then
    TEMPLATE_TYPE="flat"
else
    case "$1" in
        -grpc|--grpc|-g)
            TEMPLATE_GROUP="grpc"
            TEMPLATE_TYPE="${2:-flat}"
            shift 2
            ;;
        -rest|--rest|-r)
            TEMPLATE_GROUP="rest"
            TEMPLATE_TYPE="${2:-flat}"
            shift 2
            ;;
        -h|--help)
            usage
            ;;
        *)
            # backward compatible: first arg is template type
            TEMPLATE_TYPE="$1"
            shift 1
            ;;
    esac
fi

if [[ "$TEMPLATE_TYPE" != "flat" && "$TEMPLATE_TYPE" != "standard" ]]; then
    usage
fi

if [ "$NO_UPDATE" -eq 1 ]; then
    if [ ! -d "$TEMPLATE_DIR" ]; then
        echo "error: templates not present in $TEMPLATE_DIR and --noupdate set."
        echo "run the script once without --noupdate to initialize templates, or install templates into $TEMPLATE_DIR manually."
        exit 1
    fi
else
    if [ ! -d "$TEMPLATE_DIR" ]; then
        sudo git clone "$REPO_URL" "$TEMPLATE_DIR"
    else
        cd "$TEMPLATE_DIR" && sudo git pull --rebase && cd - >/dev/null
    fi

    if [ ! -d "$TEMPLATE_DIR/.git" ]; then
        echo "error: $TEMPLATE_DIR is not a valid git repository."
        exit 1
    fi
fi

TEMPLATE_SUBDIR="$TEMPLATE_DIR/$TEMPLATE_GROUP/$TEMPLATE_TYPE"
if [ ! -d "$TEMPLATE_SUBDIR" ]; then
    echo "error: template '$TEMPLATE_GROUP/$TEMPLATE_TYPE' not found in $TEMPLATE_DIR"
    exit 1
fi

if [ -e "./go.mod" ]; then
    read -p "go.mod exists here. Continue and overwrite? [y/N] " ans
    [[ "$ans" =~ ^[Yy]$ ]] || exit 1
fi

rsync -av --exclude='.git' --exclude='svc-init' "$TEMPLATE_SUBDIR"/ ./ || {
    echo "error: failed to copy template to current directory."
    exit 1
}

detected_module=""
if git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
    remote_url=$(git config --get remote.origin.url || true)
    if [ -n "$remote_url" ]; then
        if [[ "$remote_url" =~ ^git@([^:]+):(.+)\.git$ ]]; then
            host="${BASH_REMATCH[1]}"
            path="${BASH_REMATCH[2]}"
            detected_module="$host/$path"
        elif [[ "$remote_url" =~ ^https?://([^/]+)/(.*)(\.git)?$ ]]; then
            host="${BASH_REMATCH[1]}"
            path="${BASH_REMATCH[2]}"
            path="${path%%.git}"
            detected_module="$host/$path"
        fi
    fi
fi

MODULE_PATH=""
if [ -n "$detected_module" ]; then
    MODULE_PATH="$detected_module"
    echo "--- detected git remote. Will use module path: $MODULE_PATH"
else
    read -p "ENTER Go module path (e.g. github.com/you/your-repo). Leave empty to skip automatic update: " MODULE_PATH
fi

if [ -n "$MODULE_PATH" ]; then
    echo "Updating module path to: $MODULE_PATH"
    if [ -f go.mod ]; then
        sed -i.bak -E "s|^module .*|module $MODULE_PATH|" go.mod && rm -f go.mod.bak
    else
        printf "--- module %s\n\nrequire (\n)\n" "$MODULE_PATH" > go.mod
    fi

    old_base="github.com/mwdev22/svc-init"
    grep -R --line-number --exclude-dir=.git "$old_base" . >/dev/null 2>&1 && {
        files=$(grep -R --line-number --exclude-dir=.git "$old_base" . | cut -d: -f1 | sort -u)
        for f in $files; do
            sed -i.bak "s|$old_base|$MODULE_PATH|g" "$f" && rm -f "$f.bak"
        done
    }

    grep -R --line-number --exclude-dir=.git "mwdev22/svc-init" . >/dev/null 2>&1 && {
        files=$(grep -R --line-number --exclude-dir=.git "mwdev22/svc-init" . | cut -d: -f1 | sort -u)
        for f in $files; do
            sed -i.bak "s|mwdev22/svc-init|${MODULE_PATH#*/}|g" "$f" && rm -f "$f.bak"
        done
    }

    dir_package=$(basename "$(pwd)")
    old_package="package $TEMPLATE_TYPE"
    new_package="package $dir_package"
    
    for f in *.go; do
        if [ -f "$f" ]; then
            if grep -q "^package $TEMPLATE_TYPE" "$f"; then
                sed -i.bak "s|^package $TEMPLATE_TYPE|$new_package|" "$f" && rm -f "$f.bak"
                echo "Updated $f: '$old_package' -> '$new_package'"
            fi
        fi
    done

    if command -v go >/dev/null 2>&1; then
        echo "running 'go mod tidy' (best-effort). This may require network access."
        (go mod tidy) || echo "go mod tidy failed or skipped; you can run it manually later."
    fi
else
    echo "--- skipping automatic go.mod/imports update. You can update module name manually in go.mod."
fi

echo "==>  ($TEMPLATE_TYPE) structure has been initialized in $(pwd)"
echo "    - verify 'go.mod' module name (updated automatically if a module path was detected or provided)"
echo "    - edit your .env as needed"
echo "    - run 'go mod tidy' if you didn't already"
